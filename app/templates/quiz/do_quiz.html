{% extends "base.html" %}
{% block title %}Làm Quiz | {{ quiz.title }}{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-3">
    <div>
        <h2 class="page-title mb-1">{{ quiz.title }}</h2>
        <p class="page-subtitle mb-0">
            {{ quiz.description or 'Không có mô tả' }}
        </p>
    </div>
    {% if countdown_seconds %}
    <div class="text-end">
        <p class="mb-1 page-subtitle">Thời gian còn lại</p>
        <div id="countdown" class="badge bg-danger fs-6"></div>
    </div>
    {% endif %}
</div>

<form method="post">
    <input type="hidden" name="time_spent" id="time_spent" value="0" />

    {% for q in questions %}
    <div class="card-soft p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center mb-1">
            <div>
                <span class="badge bg-secondary me-2">Câu {{ loop.index }}</span>
                {% if q.difficulty %}
                <span class="badge bg-info">{{ q.difficulty|capitalize }}</span>
                {% endif %}
            </div>
            {% if q.time_limit %}
            <small class="text-muted">Giới hạn: {{ q.time_limit }} giây</small>
            {% endif %}
        </div>
        <p class="mb-2">{{ q.content }}</p>

        {% if q.type in ('mcq', 'true_false') %}
            {% for choice in q.choices %}
            <label class="answer-option">
                <input
                    type="radio"
                    name="q_{{ q.id }}"
                    value="{{ choice.id }}"
                    class="form-check-input me-2"
                />
                <span>{{ choice.content }}</span>
            </label>
            {% endfor %}
        {% elif q.type == 'fill_in' %}
            <input
                type="text"
                class="form-control"
                name="q_{{ q.id }}"
                placeholder="Nhập đáp án của bạn"
            />
        {% else %}
            <textarea
                class="form-control"
                name="q_{{ q.id }}"
                rows="3"
                placeholder="Nhập câu trả lời (tự luận)"
            ></textarea>
        {% endif %}
    </div>
    {% endfor %}

    <div class="d-flex justify-content-end mt-3">
        <button type="submit" class="btn btn-primary-soft px-4">
            Nộp bài
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    let timeSpent = 0;
    setInterval(() => {
        timeSpent += 1;
        document.getElementById("time_spent").value = timeSpent;
    }, 1000);

    {% if countdown_seconds %}
    let remaining = {{ countdown_seconds }};
    const countdownEl = document.getElementById("countdown");

    function updateCountdown() {
        if (!countdownEl) return;
        const m = Math.floor(remaining / 60);
        const s = remaining % 60;
        countdownEl.textContent = m.toString().padStart(2, "0") + ":" + s.toString().padStart(2, "0");

        if (remaining <= 0) {
            document.querySelector("form").submit();
        } else {
            remaining -= 1;
            setTimeout(updateCountdown, 1000);
        }
    }
    updateCountdown();
    {% endif %}
</script>
{% endblock %}
